1 INPUT "Input file";I$
2 INPUT "Output file";O$
10 DEFINT A-Z:COLOR 15,1,1:SCREEN 2,2,0
20 BLOAD I$,S
30 REM DEFINE POINTER SPRITE 10x3
30 S$="":FOR A=0 TO 31:READ X:S$=S$+CHR$(X):NEXT A  
40 SPRITE$(0)=S$
50 A=PEEK(4)+256*PEEK(5)+384
60 REM DEFINE SPRITES FOR NUMBERS 0-9
60 FOR X=0 TO 9
70 S$="":FOR Y=0 TO 7
80 C=PEEK(A+X*8+Y):S$=S$+CHR$(C):NEXT Y
90 S$=S$+STRING$(24,0)
100 SPRITE$(X+1)=S$:NEXT X
110 REM DEFINE SPRITES FOR HEX NUMBERS A-F
110 A=PEEK(4)+256*PEEK(5)+520
120 FOR X=0 TO 5
130 S$="":FOR Y=0 TO 7
140 C=PEEK(A+X*8+Y):S$=S$+CHR$(C):NEXT Y
150 S$=S$+STRING$(24,0)
160 SPRITE$(X+11)=S$:NEXT X
180 REM DEFINE SPRITE FOR BACKGROUND FOR DIALOG TO SET COLORS
180 SPRITE$(17)=STRING$(32,255)
500 REM MAIN LOOP
500 REM A - ANALYZE AND MARK POSITIONS WITH SAME FORE AND BACK COLOUR
500 REM CURSORS - MOVE POINTER  
500 REM APPLY NEW COLOR
500 REM C - SET NEW COLOR FOR APPLICATION
500 REM X - SWAP FORE AND BACK COLOR AND INVERT PATTERN
500 REM T - INVERT PATTERN ONLY
500 REM S - SAVE CURRENT PICTURE
500 REM P - SET NEW PATTERN
500 REM . - APPLY NEW PATTERN
500 X=0:Y=0
510 GOSUB 11000:GOSUB 12000
520 S$=INKEY$
530 IF S$="" THEN GOSUB 11000:GOTO 520
540 IF S$="A" OR S$="a" GOTO 1000
541 IF S$="C" OR S$="c" GOTO 19000
542 IF S$=" " GOTO 14000
543 IF S$="T" OR S$="t" GOTO 16000
544 IF S$="S" OR S$="s" GOTO 17000
545 IF S$="X" OR S$="x" GOTO 18000
546 IF S$="P" OR S$="p" GOTO 20000
547 IF S$="." GOTO 21000
550 IF S$<>CHR$(28) GOTO 580
560 X=X+1:IF X>31 THEN X=0:Y=(Y+1) MOD 192
570 GOTO 510
580 IF S$<>CHR$(29) GOTO 610
590 X=X-1:IF X<0 THEN X=31:Y=Y-1:IF Y<0 THEN Y=191
600 GOTO 510
610 IF S$<>CHR$(30) GOTO 640
620 Y=Y-1:IF Y<0 THEN Y=191
630 GOTO 510
640 IF S$<>CHR$(31) GOTO 510
650 Y=(Y+1) MOD 192
660 GOTO 510

1000 REM INITIAL RECOLOUR - BRIGHTER TO FOREGROUND
1000 FOR Y=0 TO 191
1010 FOR X=0 TO 31
1015 GOSUB 11000
1020 GOSUB 15000
1050 IF BC=FC THEN VPOKE CA,255:VPOKE PA,0:GOTO 1500
1060 IF FC=1 OR FC=0 GOTO 1400 
1070 IF FC=12 AND (BC=10 OR BC=3) THEN GOTO 1400
1390 GOTO 1500
1400 VPOKE CA,BC*16+FC:VPOKE PA,P XOR 255
1500 NEXT X:NEXT Y
10000 GOTO 510

11000 REM PLACE POINTER
11000 PUT SPRITE 0,(X*8-1,Y-2),INT(RND(1)*15)+1,0:RETURN

12000 REM DISPLAY COLORS AT CURSOR
12000 K=VPEEK((Y\8)*256+X*8+(Y MOD 8)+BASE(11))
12010 FK=K\16:BK=K MOD 16
12020 IF X>=30 AND Y>=184 THEN KX=0 ELSE KX=240
12030 PUT SPRITE 31,(KX,183),1,17
12040 PUT SPRITE 1,(KX+1,183),15,FK+1
12050 PUT SPRITE 2,(KX+9,183),15,BK+1
12060 RETURN

13000 REM SET NEW COLOR/PATTERN DIALOG, USE TEMPORARY VARIABLE TT
13000 PUT SPRITE 31,(120,88),9,17
13010 PUT SPRITE 1,(121,92),15,(TT\16)+1
13020 PUT SPRITE 2,(129,92),15,(TT MOD 16)+1
13021 PUT SPRITE 0,(0,209),0,0
13025 BK=TT MOD 16
13030 S$=INKEY$:IF S$="" GOTO 13030
13040 K=ASC(S$)
13050 IF K>=48 AND K<=57 THEN TT=(K-48)*16+BK:GOTO 13090
13060 IF K>=65 AND K<=70 THEN TT=(K-55)*16+BK:GOTO 13090
13070 IF K>=97 AND K<=102 THEN TT=(K-87)*16+BK:GOTO 13090
13075 IF K=13 THEN RETURN
13080 GOTO 13030
13090 PUT SPRITE 1,(121,92),15,(TT\16)+1
13100 S$=INKEY$:IF S$="" GOTO 13100
13110 K=ASC(S$)
13120 IF K>=48 AND K<=57 THEN TT=(TT AND 240)+K-48:GOTO 13170
13130 IF K>=65 AND K<=70 THEN TT=(TT AND 240)+K-55:GOTO 13170
13140 IF K>=97 AND K<=102 THEN TT=(TT AND 240)+K-87:GOTO 13170
13150 IF K=13 THEN RETURN
13160 GOTO 13100
13170 PUT SPRITE 2,(129,92),15,(TT MOD 16)+1
13180 GOTO 13025

14000 REM APPLY COLOR 
14000 GOSUB 15000
14010 VPOKE CA,NC
14020 GOTO 510

15000 REM HELPER FUNCTION TO GET COLORS  
15000 A=(Y\8)*256+X*8+(Y MOD 8):PA=A+BASE(12):CA=A+BASE(11)
15010 P=VPEEK(PA):C=VPEEK(CA)
15020 FC=C\16:BC=C MOD 16
15030 RETURN

16000 REM INVERT PATTERN  
16000 GOSUB 15000
16010 VPOKE PA,P XOR 255
16020 GOTO 510

17000 REM SAVE BITMAP
17000 PUT SPRITE 0,(0,209)
17010 PUT SPRITE 1,(0,209)
17020 PUT SPRITE 2,(0,209)
17030 PUT SPRITE 31,(0,209)
17040 BSAVE O$,0,&H3FFF,S
17050 GOTO 510

18000 REM SWAP COLORS AND INVERT PATTERN
18000 GOSUB 15000
18010 VPOKE CA,BC*16+FC
18020 GOTO 16010

19000 REM SET NEW COLOR
19000 TT=NC:GOSUB 13000:NC=TT:GOTO 510

20000 REM SET NEW PATTERN
20000 TT=NP:GOSUB 13000:NP=TT:GOTO 510

21000 REM APPLY NEW PATTERN
21000 GOSUB 15000:VPOKE PA,NP:GOTO 510

30000 DATA 255,128,255,0,0,0,0,0
30010 DATA 0,0,0,0,0,0,0,0
30020 DATA 192,64,192,0,0,0,0,0
30030 DATA 0,0,0,0,0,0,0,0
